<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>ãƒãƒ£ãƒƒãƒˆãƒ«ãƒ¼ãƒ </title>
  <style>
    body { font-family: sans-serif; margin: 0; padding: 0; display: flex; flex-direction: column; height: 100vh; }
    #header { 
      background: #007bff; 
      color: white; 
      padding: 0.5rem 1rem; 
      display: flex; 
      justify-content: space-between; 
      align-items: center;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    #header h1 { margin: 0; font-size: 1.2rem; }
    #share-btn { 
      background: rgba(255,255,255,0.2); 
      border: 1px solid rgba(255,255,255,0.3); 
      color: white; 
      padding: 0.3rem 0.8rem; 
      border-radius: 4px; 
      cursor: pointer;
      font-size: 0.9rem;
    }
    #share-btn:hover { background: rgba(255,255,255,0.3); }
    #exit-btn { 
      background: rgba(255,255,255,0.2); 
      border: 1px solid rgba(255,255,255,0.3); 
      color: white; 
      padding: 0.3rem 0.8rem; 
      border-radius: 4px; 
      cursor: pointer;
      font-size: 0.9rem;
      margin-left: 0.5rem;
    }
    #exit-btn:hover { background: rgba(255,255,255,0.3); }
    #share-modal { 
      display: none; 
      position: fixed; 
      top: 0; 
      left: 0; 
      width: 100%; 
      height: 100%; 
      background: rgba(0,0,0,0.5); 
      z-index: 1000;
    }
    #share-content { 
      position: absolute; 
      top: 50%; 
      left: 50%; 
      transform: translate(-50%, -50%); 
      background: white; 
      padding: 2rem; 
      border-radius: 8px; 
      max-width: 500px; 
      width: 90%;
    }
    #share-content h3 { margin-top: 0; color: #333; }
    .url-input { 
      display: flex; 
      gap: 0.5rem; 
      margin: 1rem 0; 
      align-items: center;
    }
    .url-input input { 
      flex: 1; 
      padding: 0.5rem; 
      border: 1px solid #ddd; 
      border-radius: 4px; 
      font-family: monospace;
    }
    .copy-btn { 
      padding: 0.5rem 1rem; 
      background: #007bff; 
      color: white; 
      border: none; 
      border-radius: 4px; 
      cursor: pointer;
    }
    .copy-btn:hover { background: #0056b3; }
    .close-btn { 
      position: absolute; 
      top: 1rem; 
      right: 1rem; 
      background: none; 
      border: none; 
      font-size: 1.5rem; 
      cursor: pointer; 
      color: #666;
    }
    .success-message { 
      color: #28a745; 
      font-weight: bold; 
      margin-top: 0.5rem;
    }
    #messages { flex: 1; overflow-y: auto; padding: 1rem; border-bottom: 1px solid #ccc; }
    .message { margin-bottom: 0.5rem; }
    .system { color: #888; font-style: italic; }
    #input-area { display: flex; padding: 0.5rem; gap: 0.5rem; }
    #text { 
      flex: 1; 
      padding: 0.5rem; 
      font-size: 1rem; 
      font-family: inherit;
      border: 1px solid #ccc;
      border-radius: 4px;
      resize: vertical;
      min-height: 40px;
      max-height: 120px;
      line-height: 1.4;
    }
    #send { 
      padding: 0.5rem 1rem; 
      font-size: 1rem; 
      background-color: #007bff;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
    }
    #send:hover {
      background-color: #0056b3;
    }
    .message-text {
      white-space: pre-wrap;
      word-wrap: break-word;
    }
  </style>
</head>
<body>
  <div id="header">
    <h1>ğŸ¤– AI ãƒãƒ£ãƒƒãƒˆãƒ«ãƒ¼ãƒ </h1>
    <div>
      <button id="share-btn">ğŸ“‹ å…±æœ‰URL</button>
      <button id="exit-btn">ğŸšª é€€å‡º</button>
    </div>
  </div>
  
  <div id="messages"></div>
  <div id="input-area">
    <textarea id="text" placeholder="ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å…¥åŠ›â€¦&#10;Ctrl+Enter: æ”¹è¡Œ&#10;Enter: é€ä¿¡" autocomplete="off"></textarea>
    <button id="send">é€ä¿¡</button>
  </div>

  <!-- å…±æœ‰URLãƒ¢ãƒ¼ãƒ€ãƒ« -->
  <div id="share-modal">
    <div id="share-content">
      <button class="close-btn" onclick="closeShareModal()">&times;</button>
      <h3>ğŸ“‹ ãƒ«ãƒ¼ãƒ ã‚’å…±æœ‰</h3>
      <p>ä»¥ä¸‹ã®URLã‚’ä»–ã®äººã«é€ã£ã¦ã€ä¸€ç·’ã«ãƒãƒ£ãƒƒãƒˆã«å‚åŠ ã—ã¦ã‚‚ã‚‰ã„ã¾ã—ã‚‡ã†ï¼</p>
      <div class="url-input">
        <input type="text" id="shareUrlInput" readonly>
        <button class="copy-btn" onclick="copyShareUrl()">ã‚³ãƒ”ãƒ¼</button>
      </div>
      <div id="copyMessage"></div>
    </div>
  </div>

  <script>
    const params = new URLSearchParams(location.search);
    const roomId = params.get("room_id");
    const userName = params.get("name") || "åç„¡ã—";
    if (!roomId) { alert("ãƒ«ãƒ¼ãƒ IDãŒæŒ‡å®šã•ã‚Œã¦ã„ã¾ã›ã‚“"); throw new Error("No room_id"); }

    const messagesDiv = document.getElementById("messages");
    const input = document.getElementById("text");
    const sendBtn = document.getElementById("send");

    // å…±æœ‰URLæ©Ÿèƒ½
    function showShareModal() {
      const shareUrl = `${window.location.origin}/chat.html?room_id=${roomId}&name=${encodeURIComponent(userName)}`;
      document.getElementById('shareUrlInput').value = shareUrl;
      document.getElementById('share-modal').style.display = 'block';
    }

    function closeShareModal() {
      document.getElementById('share-modal').style.display = 'none';
    }

    async function copyShareUrl() {
      const urlInput = document.getElementById('shareUrlInput');
      const copyMessage = document.getElementById('copyMessage');
      
      try {
        await navigator.clipboard.writeText(urlInput.value);
        copyMessage.innerHTML = '<span class="success-message">âœ… URLã‚’ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸï¼</span>';
        setTimeout(() => {
          copyMessage.innerHTML = '';
        }, 2000);
      } catch (err) {
        // ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯
        urlInput.select();
        document.execCommand('copy');
        copyMessage.innerHTML = '<span class="success-message">âœ… URLã‚’ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸï¼</span>';
        setTimeout(() => {
          copyMessage.innerHTML = '';
        }, 2000);
      }
    }

    // ãƒ¢ãƒ¼ãƒ€ãƒ«å¤–ã‚¯ãƒªãƒƒã‚¯ã§é–‰ã˜ã‚‹
    document.getElementById('share-modal').addEventListener('click', (e) => {
      if (e.target.id === 'share-modal') {
        closeShareModal();
      }
    });

    // å…±æœ‰ãƒœã‚¿ãƒ³ã‚¯ãƒªãƒƒã‚¯
    document.getElementById('share-btn').addEventListener('click', showShareModal);

    // é€€å‡ºãƒœã‚¿ãƒ³ã‚¯ãƒªãƒƒã‚¯
    document.getElementById('exit-btn').addEventListener('click', () => {
      if (confirm('æœ¬å½“ã«ãƒ«ãƒ¼ãƒ ã‹ã‚‰é€€å‡ºã—ã¾ã™ã‹ï¼Ÿ')) {
        // WebSocketã‚’é–‰ã˜ã‚‹
        if (ws && ws.readyState === WebSocket.OPEN) {
          ws.close();
        }
        // ãƒ›ãƒ¼ãƒ ãƒšãƒ¼ã‚¸ã«æˆ»ã‚‹
        window.location.href = '/';
      }
    });

    const wsProtocol = location.protocol === "https:" ? "wss" : "ws";
    const ws = new WebSocket(`${wsProtocol}://${location.host}/ws/${roomId}?name=${encodeURIComponent(userName)}`);

    ws.onmessage = (event) => {
      const msg = JSON.parse(event.data);
      const el = document.createElement("div"); 
      el.classList.add("message");
      if (msg.type === "system") {
        el.classList.add("system"); 
        el.textContent = msg.text;
      } else {
        el.innerHTML = `<strong>${msg.name}:</strong> <span class="message-text">${msg.text}</span>`;
      }
      messagesDiv.appendChild(el);
      messagesDiv.scrollTop = messagesDiv.scrollHeight;
    };

    ws.onopen = () => console.log("WebSocket connected");
    ws.onclose = () => console.log("WebSocket disconnected");

    function sendMessage() {
      const text = input.value.trim(); 
      if (!text) return;
      const payload = { type: "chat", name: userName, text };
      ws.send(JSON.stringify(payload)); 
      input.value = "";
      // ãƒ†ã‚­ã‚¹ãƒˆã‚¨ãƒªã‚¢ã®é«˜ã•ã‚’ãƒªã‚»ãƒƒãƒˆ
      input.style.height = 'auto';
    }

    sendBtn.addEventListener("click", sendMessage);
    
    input.addEventListener("keydown", (e) => { 
      if (e.key === "Enter") {
        if (e.ctrlKey) {
          // Ctrl+Enter: æ”¹è¡Œã‚’æŒ¿å…¥
          const start = input.selectionStart;
          const end = input.selectionEnd;
          const value = input.value;
          input.value = value.substring(0, start) + "\n" + value.substring(end);
          input.selectionStart = input.selectionEnd = start + 1;
          e.preventDefault();
        } else {
          // Enter: é€ä¿¡
          e.preventDefault();
          sendMessage();
        }
      }
    });

    // ãƒ†ã‚­ã‚¹ãƒˆã‚¨ãƒªã‚¢ã®è‡ªå‹•ãƒªã‚µã‚¤ã‚º
    input.addEventListener("input", () => {
      input.style.height = 'auto';
      input.style.height = Math.min(input.scrollHeight, 120) + 'px';
    });

    // ãƒšãƒ¼ã‚¸ã‚’é›¢ã‚Œã‚‹æ™‚ã«WebSocketã‚’é–‰ã˜ã‚‹
    window.addEventListener('beforeunload', () => {
      if (ws && ws.readyState === WebSocket.OPEN) {
        ws.close();
      }
    });
  </script>
</body>
</html>