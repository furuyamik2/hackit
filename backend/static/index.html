<!doctype html>
<html lang="ja">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>ãƒãƒ£ãƒƒãƒˆãƒ«ãƒ¼ãƒ </title>
    <style>
      body {
        font-family: sans-serif;
        padding: 2rem;
        max-width: 500px;
        margin: auto;
        background-color: #f5f5f5;
      }
      .container {
        background: white;
        padding: 2rem;
        border-radius: 8px;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
      }
      h1 {
        text-align: center;
        color: #333;
        margin-bottom: 2rem;
      }
      section {
        margin-bottom: 2rem;
        padding: 1.5rem;
        border: 1px solid #e0e0e0;
        border-radius: 6px;
        background: #fafafa;
      }
      h2 {
        margin-top: 0;
        color: #555;
        font-size: 1.2rem;
      }
      label,
      input,
      button {
        display: block;
        width: 100%;
        margin-bottom: 1rem;
        box-sizing: border-box;
      }
      input {
        padding: 0.75rem;
        font-size: 1rem;
        border: 1px solid #ddd;
        border-radius: 4px;
      }
      input:focus {
        outline: none;
        border-color: #007bff;
        box-shadow: 0 0 0 2px rgba(0, 123, 255, 0.25);
      }
      button {
        padding: 0.75rem;
        font-size: 1rem;
        background-color: #007bff;
        color: white;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        transition: background-color 0.2s;
      }
      button:hover {
        background-color: #0056b3;
      }
      button:disabled {
        background-color: #6c757d;
        cursor: not-allowed;
      }
      .result {
        margin-top: 1rem;
        padding: 1rem;
        border-radius: 4px;
        background: #d4edda;
        border: 1px solid #c3e6cb;
        color: #155724;
      }
      .error {
        background: #f8d7da;
        border: 1px solid #f5c6cb;
        color: #721c24;
      }
      .share-url {
        background: #e7f3ff;
        border: 1px solid #b3d9ff;
        color: #004085;
        padding: 1rem;
        border-radius: 4px;
        margin-top: 1rem;
      }
      .url-input {
        display: flex;
        gap: 0.5rem;
        align-items: center;
      }
      .url-input input {
        flex: 1;
        margin-bottom: 0;
        font-family: monospace;
        font-size: 0.9rem;
      }
      .copy-btn {
        padding: 0.5rem 1rem;
        font-size: 0.9rem;
        white-space: nowrap;
      }
      .success-message {
        color: #28a745;
        font-weight: bold;
        margin-top: 0.5rem;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <h1>ğŸ¤– AI ãƒãƒ£ãƒƒãƒˆãƒ«ãƒ¼ãƒ </h1>

      <!-- ãƒ«ãƒ¼ãƒ ä½œæˆ -->
      <section>
        <h2>ğŸ“ ãƒ«ãƒ¼ãƒ ä½œæˆ</h2>
        <label for="hostName">ãƒ‹ãƒƒã‚¯ãƒãƒ¼ãƒ </label>
        <input type="text" id="hostName" placeholder="ã‚ãªãŸã®åå‰ã‚’å…¥åŠ›" />
        <button id="createBtn">ãƒ«ãƒ¼ãƒ ã‚’ä½œæˆ</button>
        <div id="createResult"></div>
      </section>

      <!-- ãƒ«ãƒ¼ãƒ å‚åŠ  -->
      <section>
        <h2>ğŸšª ãƒ«ãƒ¼ãƒ ã«å‚åŠ </h2>
        <label for="joinRoomId">ãƒ«ãƒ¼ãƒ ID</label>
        <input
          type="text"
          id="joinRoomId"
          placeholder="å‚åŠ ã—ãŸã„ãƒ«ãƒ¼ãƒ IDã‚’å…¥åŠ›"
        />
        <label for="joinName">ãƒ‹ãƒƒã‚¯ãƒãƒ¼ãƒ </label>
        <input type="text" id="joinName" placeholder="ã‚ãªãŸã®åå‰ã‚’å…¥åŠ›" />
        <button id="joinBtn">å‚åŠ ã™ã‚‹</button>
        <div id="joinResult"></div>
      </section>
    </div>

    <script>
      // ã‚³ãƒ”ãƒ¼æ©Ÿèƒ½
      async function copyToClipboard(text) {
        try {
          await navigator.clipboard.writeText(text);
          return true;
        } catch (err) {
          // ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯: å¤ã„ãƒ–ãƒ©ã‚¦ã‚¶ç”¨
          const textArea = document.createElement("textarea");
          textArea.value = text;
          document.body.appendChild(textArea);
          textArea.select();
          document.execCommand("copy");
          document.body.removeChild(textArea);
          return true;
        }
      }

      // å…±æœ‰URLã‚’è¡¨ç¤º
      function showShareUrl(roomId, hostName) {
        const shareUrl = `${window.location.origin}/chat.html?room_id=${roomId}&name=${encodeURIComponent(hostName)}`;
        const resultDiv = document.getElementById("createResult");

        resultDiv.innerHTML = `
        <div class="result">
          <strong>âœ… ãƒ«ãƒ¼ãƒ ä½œæˆæˆåŠŸï¼</strong><br>
          <div class="share-url">
            <strong>ğŸ“‹ å…±æœ‰URL:</strong><br>
            <div class="url-input">
              <input type="text" value="${shareUrl}" readonly id="shareUrlInput">
              <button class="copy-btn" onclick="copyShareUrl()">ã‚³ãƒ”ãƒ¼</button>
            </div>
            <div id="copyMessage"></div>
          </div>
          <br>
          <a href="${shareUrl}" style="color: #007bff; text-decoration: none;">
            ğŸš€ ãƒãƒ£ãƒƒãƒˆç”»é¢ã‚’é–‹ã
          </a>
        </div>
      `;
      }

      // å…±æœ‰URLã‚’ã‚³ãƒ”ãƒ¼
      async function copyShareUrl() {
        const urlInput = document.getElementById("shareUrlInput");
        const copyMessage = document.getElementById("copyMessage");

        const success = await copyToClipboard(urlInput.value);
        if (success) {
          copyMessage.innerHTML =
            '<span class="success-message">âœ… URLã‚’ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸï¼</span>';
          setTimeout(() => {
            copyMessage.innerHTML = "";
          }, 2000);
        }
      }

      // ãƒ«ãƒ¼ãƒ ä½œæˆ
      document
        .getElementById("createBtn")
        .addEventListener("click", async () => {
          const name = document.getElementById("hostName").value.trim();
          if (!name) {
            document.getElementById("createResult").innerHTML =
              '<div class="error">âš ï¸ ãƒ‹ãƒƒã‚¯ãƒãƒ¼ãƒ ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„</div>';
            return;
          }

          const createBtn = document.getElementById("createBtn");
          createBtn.disabled = true;
          createBtn.textContent = "ä½œæˆä¸­...";

          try {
            const res = await fetch("/rooms", {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({ host_name: name }),
            });

            if (!res.ok) {
              throw new Error("ä½œæˆã«å¤±æ•—ã—ã¾ã—ãŸ");
            }

            const { room_id } = await res.json();
            showShareUrl(room_id, name);
          } catch (error) {
            document.getElementById("createResult").innerHTML =
              `<div class="error">âŒ ${error.message}</div>`;
          } finally {
            createBtn.disabled = false;
            createBtn.textContent = "ãƒ«ãƒ¼ãƒ ã‚’ä½œæˆ";
          }
        });

      // ãƒ«ãƒ¼ãƒ å‚åŠ 
      document.getElementById("joinBtn").addEventListener("click", async () => {
        const roomId = document.getElementById("joinRoomId").value.trim();
        const name = document.getElementById("joinName").value.trim();

        if (!roomId || !name) {
          document.getElementById("joinResult").innerHTML =
            '<div class="error">âš ï¸ ãƒ«ãƒ¼ãƒ IDã¨ãƒ‹ãƒƒã‚¯ãƒãƒ¼ãƒ ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„</div>';
          return;
        }

        const joinBtn = document.getElementById("joinBtn");
        joinBtn.disabled = true;
        joinBtn.textContent = "å‚åŠ ä¸­...";

        try {
          const res = await fetch(`/rooms/${roomId}`, {
            method: "GET",
            headers: { "Content-Type": "application/json" },
          });

          if (!res.ok) {
            throw new Error("ãƒ«ãƒ¼ãƒ ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“");
          }

          const chatUrl = `/chat.html?room_id=${roomId}&name=${encodeURIComponent(name)}`;
          document.getElementById("joinResult").innerHTML = `
          <div class="result">
            <strong>âœ… å‚åŠ æˆåŠŸï¼</strong><br>
            <a href="${chatUrl}" style="color: #007bff; text-decoration: none;">
              ğŸš€ ãƒãƒ£ãƒƒãƒˆç”»é¢ã‚’é–‹ã
            </a>
          </div>
        `;
        } catch (error) {
          document.getElementById("joinResult").innerHTML =
            `<div class="error">âŒ ${error.message}</div>`;
        } finally {
          joinBtn.disabled = false;
          joinBtn.textContent = "å‚åŠ ã™ã‚‹";
        }
      });

      // Enterã‚­ãƒ¼ã§é€ä¿¡
      document.getElementById("hostName").addEventListener("keypress", (e) => {
        if (e.key === "Enter") {
          document.getElementById("createBtn").click();
        }
      });

      document
        .getElementById("joinRoomId")
        .addEventListener("keypress", (e) => {
          if (e.key === "Enter") {
            document.getElementById("joinName").focus();
          }
        });

      document.getElementById("joinName").addEventListener("keypress", (e) => {
        if (e.key === "Enter") {
          document.getElementById("joinBtn").click();
        }
      });
    </script>
  </body>
</html>
